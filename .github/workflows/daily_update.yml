name: Daily Data Pipeline

# Cáº¥u hÃ¬nh thá»i gian cháº¡y
on:
  schedule:
    # Cháº¡y vÃ o 00:00 UTC hÃ ng ngÃ y (tá»©c 7:00 sÃ¡ng Viá»‡t Nam)
    - cron: '0 0 * * *'
  # Cho phÃ©p báº¥m nÃºt cháº¡y thá»§ cÃ´ng Ä‘á»ƒ test ngay láº­p tá»©c
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-etl-pipeline:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Láº¥y mÃ£ nguá»“n tá»« GitHub vá» mÃ¡y chá»§ áº£o
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2. CÃ i Ä‘áº·t Python 3.9
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3. CÃ i Ä‘áº·t cÃ¡c thÆ° viá»‡n cáº§n thiáº¿t
    - name: Install dependencies
      run: |
        pip install pandas kaggle

    # 4. Táº£i dá»¯ liá»‡u tá»« Kaggle (DÃ¹ng Secret báº¡n vá»«a táº¡o)
    - name: Download Dataset from Kaggle
      env:
        KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
        KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
      run: |
        # Táº¡o thÆ° má»¥c raw náº¿u chÆ°a cÃ³
        mkdir -p data/raw
        
        # Táº£i bá»™ Olist vá» vÃ  giáº£i nÃ©n vÃ o thÆ° má»¥c data/raw
        # Lá»‡nh -o (overwrite) Ä‘á»ƒ ghi Ä‘Ã¨ náº¿u file cÅ© tá»“n táº¡i
        kaggle datasets download -d olistbr/brazilian-ecommerce -p data/raw --unzip -o
        
        echo "âœ… ÄÃ£ táº£i xong dá»¯ liá»‡u tá»« Kaggle!"
        ls -l data/raw  # Liá»‡t kÃª file Ä‘á»ƒ kiá»ƒm tra

    # 5. Cháº¡y script Time Travel Ä‘á»ƒ xá»­ lÃ½ dá»¯ liá»‡u
    - name: Run ETL Script (Time Travel)
      run: python etl_pipeline/daily_replay.py

    # 6. LÆ°u káº¿t quáº£ má»›i vÃ o Git (Commit & Push)
    - name: Commit and Push changes
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        git add data/live/
        
        if git diff --staged --quiet; then
          echo "âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u má»›i Ä‘á»ƒ commit."
        else
<<<<<<< HEAD
          git commit -m "Auto-update: Cáº­p nháº­t dá»¯ liá»‡u ngÃ y $(date +'%Y-%m-%d')"
          
          # --- QUAN TRá»ŒNG: DÃ²ng nÃ y giÃºp chá»¯a lá»—i "rejected" ---
          git pull --rebase origin main
          # -----------------------------------------------------
          
=======
          git commit -m "Auto-update: Cáº­p nháº­t dá»¯ liá»‡u bÃ¡n hÃ ng ngÃ y $(date +'%Y-%m-%d')"
          
          # --- QUAN TRá»ŒNG: KÃ‰O CODE Vá»€ TRÆ¯á»šC KHI Äáº¨Y ---
          # --rebase giÃºp gá»™p code mÆ°á»£t mÃ  hÆ¡n
          git pull --rebase origin main
          
          # Sau khi pull xong má»›i Ä‘Æ°á»£c push
>>>>>>> 753a0177f37f5eb92a061e1266040d2178ffd18e
          git push origin main
          echo "ğŸš€ ÄÃ£ Ä‘áº©y dá»¯ liá»‡u má»›i lÃªn GitHub!"
        fi
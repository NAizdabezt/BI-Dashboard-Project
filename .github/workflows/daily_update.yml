name: Daily Data Pipeline

# C·∫•u h√¨nh th·ªùi gian ch·∫°y
on:
  schedule:
    # Ch·∫°y v√†o 00:00 UTC h√†ng ng√†y (t·ª©c 7:00 s√°ng Vi·ªát Nam)
    - cron: '0 0 * * *'
  # Cho ph√©p b·∫•m n√∫t ch·∫°y th·ªß c√¥ng ƒë·ªÉ test ngay l·∫≠p t·ª©c
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-etl-pipeline:
    runs-on: ubuntu-latest
    
    steps:
    # 1. L·∫•y m√£ ngu·ªìn t·ª´ GitHub v·ªÅ m√°y ch·ªß ·∫£o
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2. C√†i ƒë·∫∑t Python 3.9
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3. C√†i ƒë·∫∑t c√°c th∆∞ vi·ªán c·∫ßn thi·∫øt
    - name: Install dependencies
      run: |
        pip install pandas kaggle

    # 4. T·∫£i d·ªØ li·ªáu t·ª´ Kaggle (D√πng Secret b·∫°n v·ª´a t·∫°o)
    - name: Download Dataset from Kaggle
      env:
        KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
        KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
      run: |
        # T·∫°o th∆∞ m·ª•c raw n·∫øu ch∆∞a c√≥
        mkdir -p data/raw
        
        # T·∫£i b·ªô Olist v·ªÅ v√† gi·∫£i n√©n v√†o th∆∞ m·ª•c data/raw
        # L·ªánh -o (overwrite) ƒë·ªÉ ghi ƒë√® n·∫øu file c≈© t·ªìn t·∫°i
        kaggle datasets download -d olistbr/brazilian-ecommerce -p data/raw --unzip -o
        
        echo "‚úÖ ƒê√£ t·∫£i xong d·ªØ li·ªáu t·ª´ Kaggle!"
        ls -l data/raw  # Li·ªát k√™ file ƒë·ªÉ ki·ªÉm tra

    # 5. Ch·∫°y script Time Travel ƒë·ªÉ x·ª≠ l√Ω d·ªØ li·ªáu
    - name: Run ETL Script (Time Travel)
      run: python etl_pipeline/daily_replay.py

    # 6. L∆∞u k·∫øt qu·∫£ m·ªõi v√†o Git (Commit & Push)
    - name: Commit and Push changes
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # Ch·ªâ add file k·∫øt qu·∫£ trong th∆∞ m·ª•c live
        git add data/live/
        
        # Ki·ªÉm tra xem c√≥ g√¨ thay ƒë·ªïi kh√¥ng r·ªìi m·ªõi commit
        if git diff --staged --quiet; then
          echo "‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu m·ªõi ƒë·ªÉ commit h√¥m nay."
        else
          git commit -m "Auto-update: C·∫≠p nh·∫≠t d·ªØ li·ªáu b√°n h√†ng ng√†y $(date +'%Y-%m-%d')"
          
          # --- QUAN TR·ªåNG: PH·∫¢I PULL TR∆Ø·ªöC KHI PUSH ---
          git pull --rebase origin main
          
          # Sau khi pull th√†nh c√¥ng m·ªõi push
          git push origin main
          echo "üöÄ ƒê√£ ƒë·∫©y d·ªØ li·ªáu m·ªõi l√™n GitHub!"
        fi
